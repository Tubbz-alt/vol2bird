This script is used to call \mbox{\hyperlink{structvol2bird}{vol2bird}} and generate vertical profiles of birds.

It replaces the vol2bird.\+groovy script.


\begin{DoxyCode}
#!/opt/baltrad/third\_party/bin/python
import sys, os, glob, time, re, traceback
import odim\_source
import \_raveio, \_polarvolume, \_pyvol2bird

VOL2BIRD\_OUTPUTDIR="/tmp"

SOURCES=  ["bejab", "bewid", "bezav", 
    "dkbor", "dkrom", "dksin", "dkste", "dkvir", 
    "eehar", "eesur",
    "hrbil", "hrosi",
    "fianj", "fiika", "fikes", "fikor", "fikuo",
    "filuo", "fiuta", "fivan", "fivim", 
    "frabb", "frale", "frbla", "frbol", "frbor", "frbou",
    "frcae", "frche", "frcol", "frgre", "frlep",
    "frmcl", "frmom", "frmtc", "frnan", "frnim",
    "fropo", "frpla", "frtou", "frtra", "frtre",
    "nldbl", "nldhl", 
    "searl", "sease", "sehud", "sekir", "sekkr", "selek",
    "selul", "seosu", "seovi", "sevar", "sevil", "seang",
    "silis", "sipas",
    "czska", "czbrd",
    "eslid", "esmad", "esval", "esmur", "esbar", "escor",
    "eszar", "essan", "essse", "esbad", "esmal", "essev",
    "esalm", "espma", "eslpa",
    "deemd", "deham", "deboo", "deros", "dehan", "dehnr", 
    "debln", "depro", "deess", "defld", "deumd", "deoft",
    "deneu", "dedrs", "denhb", "detur", "deeis", "deflg",
    "demuc", "desna", "demem",
    "plleg", "plram", "plpas", "plrze", "plpoz", "plswi",
    "plgda", "plbrz",
    "nober", "noosl", "nohgb", "norsa", "norst", "nobml",
    "noand", "nohas", "nosta", "nohur", 
    "ukcle", "ukham", "ukche", "ukcas", "ukpre", "uking",
    "ukcyg", "ukdud", "uklew", "ukcob", "ukhhd", "ukmun",
    "ukthu", "ukdea", "ukhmy", 
    "chalb", "chdol", "chlem",
    "skjav", "skkoj"]

def add\_daylight(t):
    l = list(t)
    l[8] = -1
    return tuple(l)

# returns the archive time as a time tuple which can be fed to GetTimeTuple.
def GetTime():
  t = time.gmtime(time.time() - 15*60)
  return add\_daylight(t)

def print\_log(msg):
  tt = time.gmtime(time.time())
  tt = add\_daylight(tt)
  logtime = time.strftime("%Y-%m-%d %H:%M", tt)
  print "%s: %s"%(logtime, msg)

def getNod(src):
    return odim\_source.NODfromSource(src)

def get\_filename(src):
  dd = src.date
  tt = src.time

  year = dd[:4]
  month = dd[4:6]
  day = dd[6:8]
  hour = tt[:2]
  minute = tt[2:4]

  return "%s\_vp\_%s%s%s%s%s00.h5"%(getNod(src), year, month, day, hour, minute)

def write\_file\_to\_outdir(out\_dir, outname, dst):
  fname = "%s/%s"%(out\_dir, outname)
  rio = \_raveio.new()
  rio.object=dst
  rio.save(fname)
  rio.close()
  print\_log("Wrote %s"%fname)

def process\_file(out\_dir, in\_name):
  vol = \_raveio.open(in\_name).object
  if \_polarvolume.isPolarVolume(vol):
    if getNod(vol) in SOURCES:
      fname = get\_filename(vol)
      v2b = \_pyvol2bird.new(vol)
      # calculate a vertical profile of birds
      vpr = v2b.vol2bird(vol)
      write\_file\_to\_outdir(out\_dir, fname, vpr)
  else:
    print\_log("Not a polar volume. Ignoring")

def GetODCPath(tt):
  import odc\_filesys
  return odc\_filesys.GetPathFromTuple(tt)

def generate(out\_dir, in\_dir=None):
    tt = GetTime()

    start = time.time()

    # Which PVOLs do we already have before starting?
    path = in\_dir
    if path == None:
      path = GetODCPath(tt)

    print\_log("PATH=%s"%path)
    fstrs = glob.glob(os.path.join(path, '*pvol*.h5'))

    for f in fstrs:
      try:
        process\_file(out\_dir, f)
      except Exception, e:
        traceback.print\_exc()

if \_\_name\_\_ == "\_\_main\_\_":
  from optparse import OptionParser
  usage = "usage: vol2bird\_generate -o <output dir>"
  usage += ""
  parser = OptionParser(usage=usage)
  parser.add\_option("-o", "--outdir", dest="out\_dir",
                    default=VOL2BIRD\_OUTPUTDIR,
                    help="Name of output directory to which to write.")
  parser.add\_option("-i", "--indir", dest="in\_dir",
                    default=None,
                    help="Name of input directory to scan for volumes.")
  (options, args) = parser.parse\_args()
  generate(options.out\_dir, options.in\_dir)
\end{DoxyCode}
 